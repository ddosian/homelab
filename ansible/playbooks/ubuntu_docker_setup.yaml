---
- name: Install docker & setup portainer agent
  hosts: docker
  become: yes
  become_method: sudo
  tasks:
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      changed_when: false
      failed_when: false

    - name: Show Docker version when present
      ansible.builtin.debug:
        msg: "Docker already installed: {{ docker_check.stdout }}"
      when: docker_check.rc == 0

    - name: Install Docker
      when: docker_check.rc != 0
      block:
        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: yes

        - name: Install required packages
          ansible.builtin.apt:
            name:
              - ca-certificates
              - curl
            state: present

        - name: Create keyrings directory
          ansible.builtin.file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'

        - name: Download Docker GPG key
          ansible.builtin.get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /etc/apt/keyrings/docker.asc
            mode: '0644'

        - name: Get Ubuntu codename
          ansible.builtin.shell: . /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}"
          register: ubuntu_codename
          changed_when: false

        - name: Add Docker repository
          ansible.builtin.copy:
            dest: /etc/apt/sources.list.d/docker.sources
            content: |
              Types: deb
              URIs: https://download.docker.com/linux/ubuntu
              Suites: {{ ubuntu_codename.stdout }}
              Components: stable
              Signed-By: /etc/apt/keyrings/docker.asc
            mode: '0644'

        - name: Update apt cache after adding Docker repo
          ansible.builtin.apt:
            update_cache: yes

        - name: Install Docker packages
          ansible.builtin.apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present